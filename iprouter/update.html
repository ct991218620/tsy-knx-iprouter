<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TSY KNX IP Router</title>

<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<style>
.center {
	margin: 0 auto;
	width: 1000px;
}
.lipadding {
	padding-left: 20px;
}
</style>
</head>

<body>
<nav class="navbar-dark bg-dark" >
  <div class="center">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" > <a class="navbar-brand"  href="#">TSY KNX IP Router</a>
      <div class="collapse navbar-collapse" id="navbarSupportedContent" >
        <ul class="navbar-nav mr-auto">
			<li class="nav-item lipadding" > <a class="nav-link" href="status.html">状态总览</a> </li>
            <li class="nav-item lipadding" > <a class="nav-link" href="update.html">固件升级</a> </li>
            <li class="nav-item lipadding" > <a class="nav-link" href="pswcfg.html">密码设置</a> </li>
 
        </ul>
      </div>
	  <ul class="navbar-nav mr-auto">
	  <li class="nav-item lipadding"> <a class="nav-link" id="sysrestart" href="#">重启</a> </li>
	  <li class="nav-item lipadding"> <a class="nav-link" id="out" href="index.html">退出</a> </li>
	  </ul>  
    </nav>
  </div>
</nav>
   <div class="center">
  <div class="card card-primary card-outline" style="margin-top: 15px">
    <div class="card-header">
      <h5 class="card-title"> <i class="fas fa-edit"></i> 固件升级</h5>
    </div>
  <div class="card-body">
 <div class="form-group">
    <label for="exampleFormControlFile1">请选择固件</label>
	 <form name="upload" method="POST" id="upfile" enctype="multipart/form-data" action="/upload">
    	<input type="file" id="inputfile" name="file1" class="form-control-file">
    </form>
  </div>
		<div id="upprog" style="display: none">
			<div>开始传输：</div>
			<div class="progress">
				<div id="prog" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="7" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
			</div>
		</div>
		<div id="flashprog" style="display: none">
			<div>开始刷写固件：</div>
			<div class="progress">
			<div id="fprog" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="7" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
			</div>
		</div>
   </div>
  </div>
	  
<div class="card-footer" style="height: 50px;padding:5px;margin-top: 15px">  
    <button type="button" id="btup" class="btn btn-primary float-right active" style="margin-right: 10px">确认升级</button>
</div>
  <!-- /container -->
 <div class="modal fade" id="exampleModal1"  data-backdrop="static" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered modal-sm">
		<div class="modal-content">
		  <div class="modal-body" style="text-align:center;margin-top:10;padding-top:10">
			<h5 >固件传输成功，重启后生效</h5>
		  </div>
		   <div class="modal-body" style="text-align:center;margin:0;padding: 0">
			<h5 >是否立即重启</h5>
		  </div>
		  <div style="text-align: center">
			<button type="button" class="btn btn-secondary" style="margin:10px" data-dismiss="modal">稍后重启</button>
			<button type="button" class="btn btn-primary" id="restart" style="margin:10px" >立即重启</button>
		  </div>
		</div>
		  
	</div>
</div> 
<div class="modal fade" id="exampleModal2"  data-backdrop="static" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered modal-sm">
		<div class="modal-content">
		  <div class="modal-body" style="text-align:center;margin-top:10;padding-top:10">
			  
			<h5 >正在传输文件</h5>
			<h5>	请等待本次传输完成后再试!</h5>
		
		  <div style="text-align: center">
			<button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
		  </div>
		</div>
		</div>
	</div>
</div>
<div class="modal fade" id="exampleModal3"  data-backdrop="static" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered modal-sm">
		<div class="modal-content">
		  <div class="modal-body" style="text-align:center;margin-top:10;padding-top:10">
			  
			<h5 >固件格式错误</h5>
			<h5>请确认后重新上传</h5>	
		  <div style="text-align: center">
			<button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
		  </div>
		</div>
		</div>
	</div>
</div>
<div class="modal fade" id="exampleModal4"  data-backdrop="static" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered modal-sm">
		<div class="modal-content">
		  <div class="modal-body" style="text-align:center;margin-top:10;padding-top:10">		  
			<h5>输入为空，请选择固件!</h5>
		  <div style="text-align: center">
			<button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
		  </div>
		</div>
		</div>
	</div>
</div>
 <div class="modal fade" id="exampleModal5"  data-backdrop="static" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content" >
          <div class="modal-body" style="text-align:center;margin-top:10;padding-top:10">
            <h5>重启系统，请确认</h5>
          </div>
          <div style="text-align: center">
            <button type="button" class="btn btn-secondary" style="margin:10px" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="restart2" style="margin:10px" >确定</button>
          </div>
        </div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #ADABAB;">
    <a href="">Powered by Tesiyun Electronics / Copyright (c) 2020 Tesiyun Electronics All rights reserved</a> </div>

</body>
<script src="js/jquery.bootstrap.cookie.js"></script> 
<script>
	var uping=0;
	$('#btup').click(function(){
		var fileInput = $('#inputfile').get(0).files[0];
		if(!fileInput){
			$('#exampleModal4').modal('show');
			console.log("iputfile empty")
			return;
		}
		if(uping==0){
			uping=1;
		}else{
			$('#exampleModal2').modal('show');
			return;
		}
	    console.log("提交");
		$("#upprog").show();
		  $("#prog").css("width","0%");
		/*$('#upfile').submit();*/
		$.ajax({
            url : $("#upfile").attr('action'),
            type : 'POST',
            cache : false,
            data : new FormData($('#upfile')[0]),
            processData : false,
            contentType : false,
			resetForm: true, 
			xhr:function(){
				myXhr = $.ajaxSettings.xhr();
				if(myXhr.upload){ //检查upload属性是否存在  
					//绑定progress事件的回调函数  
					myXhr.upload.addEventListener('progress',function(e){
						var curr=e.loaded;
						var total=e.total;
						process=parseInt(curr/total*100);
					    $("#prog").css("width",process + "%").text(process+"%");
					}, false);   
				}  
				return myXhr; 
			},
            success : function(result) {
				
				console.log(result);
				var res = JSON.parse(result);
				console.log(res);
			   $("#prog").removeClass("progress-bar-striped");
			   $("#prog").css("width",process + "%").text("传输完成");
				console.log("send ok!");
				uping=0;
				if(res.ret==1)
				{
					$('#exampleModal2').modal('hide');
					$('#exampleModal3').modal('hide');
					$("#flashprog").show();
					$("#fprog").css("width","0%");
					var sitv = setInterval(function(){
						var prog_url = "/cgi-bin/flashprog"                  // prog_url指请求进度的url，后面会在django中设置
						$.getJSON(prog_url, function(res){
							console.log(res);
							$("#fprog").css("width",res.status + "%").text(res.status+"%");     // 改变进度条进度，注意这里是内层的div， res是后台返回的进度
							if(res.status==100){
								clearInterval(sitv); 
								$("#fprog").removeClass("progress-bar-striped");
								$("#fprog").css("width",res.status + "%").text("传输完成");    
								$('#exampleModal1').modal('show');	
							}
						});
					}, 250);               	
				}else{
					$('#exampleModal1').modal('hide');
					$('#exampleModal2').modal('hide');
					$('#exampleModal3').modal('show');
				}
            }
        });
	}); //独立地址模态框确认按键
	$('#restart,#restart2').click(function(){
	        window.location.href="restart.html";
	}); 
	$('#exampleModal1,#exampleModal3').on('hide.bs.modal', function () {
		  $("#upprog").hide();
		  $("#prog").css("width","0%");
		  $("#prog").addClass("progress-bar-striped");
		   
});  //打开组地址模态框后清除input输入
	$('#sysrestart').click(function(){
		$('#exampleModal5').modal('show');
	});  
</script>
</html>
